name: SITL Mission Roundtrip

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * *"

jobs:
  sitl-mission-roundtrip:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Start ArduPilot SITL container
        run: |
          docker pull radarku/ardupilot-sitl
          docker run -d --rm --name ardupilot-sitl -p 5760:5760 radarku/ardupilot-sitl

      - name: Start bridge and wait for heartbeat path
        run: |
          python - <<'PY'
          import os
          import signal
          import socket
          import subprocess
          import sys
          import time

          def wait_for_tcp(timeout_s: int) -> bool:
              deadline = time.time() + timeout_s
              while time.time() < deadline:
                  sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                  sock.settimeout(1)
                  try:
                      sock.connect(("127.0.0.1", 5760))
                      return True
                  except OSError:
                      time.sleep(1)
                  finally:
                      sock.close()
              return False

          def stop_file_pid(path: str):
              if not os.path.exists(path):
                  return
              try:
                  pid = int(open(path, 'r', encoding='utf-8').read().strip())
                  os.kill(pid, signal.SIGTERM)
              except Exception:
                  pass

          for attempt in range(1, 4):
              if not wait_for_tcp(90):
                  print(f"Attempt {attempt}: SITL TCP endpoint did not come up")
              else:
                  log = open('/tmp/mavproxy.log', 'w', encoding='utf-8')
                  proc = subprocess.Popen([
                      'uvx', '--from', 'mavproxy', '--with', 'future', '--python', '3.11',
                      'mavproxy.py', '--master=tcp:127.0.0.1:5760', '--out=udp:127.0.0.1:14550',
                      '--daemon', '--non-interactive',
                      '--default-modules=link,signing,log,wp,rally,fence,param,relay,tuneopt,arm,mode,calibration,rc,auxopt,misc,cmdlong,battery,terrain,output,layout'
                  ], stdout=log, stderr=subprocess.STDOUT)
                  open('/tmp/mavproxy.pid', 'w', encoding='utf-8').write(str(proc.pid))

                  sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
                  sock.bind(("0.0.0.0", 14550))
                  sock.settimeout(1)
                  deadline = time.time() + 120
                  got_udp = False

                  while time.time() < deadline:
                      if proc.poll() is not None:
                          print(f"Attempt {attempt}: MAVProxy exited early with {proc.returncode}")
                          break
                      try:
                          data, _addr = sock.recvfrom(4096)
                          if data:
                              got_udp = True
                              break
                      except TimeoutError:
                          pass

                  sock.close()
                  log.close()
                  if got_udp:
                      print(f"Attempt {attempt}: received UDP payload from bridge")
                      sys.exit(0)

              stop_file_pid('/tmp/mavproxy.pid')
              subprocess.run(['docker', 'rm', '-f', 'ardupilot-sitl'], check=False)
              subprocess.run([
                  'docker', 'run', '-d', '--rm', '--name', 'ardupilot-sitl', '-p', '5760:5760',
                  'radarku/ardupilot-sitl'
              ], check=True)

          raise SystemExit('Timed out waiting for SITL UDP data after 3 attempts')
          PY

      - name: Run SITL roundtrip suite
        env:
          MP_SITL_UDP_BIND: 0.0.0.0:14550
        run: cargo test -p mp-telemetry-core sitl_roundtrip -- --ignored --nocapture --test-threads=1

      - name: Dump bridge logs on failure
        if: failure()
        run: |
          if [ -f /tmp/mavproxy.log ]; then
            cat /tmp/mavproxy.log
          fi
          docker logs ardupilot-sitl || true

      - name: Stop SITL container
        if: always()
        run: |
          if [ -f /tmp/mavproxy.pid ]; then
            kill $(cat /tmp/mavproxy.pid) || true
          fi
          docker rm -f ardupilot-sitl || true
